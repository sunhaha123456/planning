<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" th:href="@{/static/easyui/themes/easy.common.css}"></link>
    <script th:inline="javascript">
        var contextPath = [[@{/}]];
        var interceptorToken = [[${token}]];
        var interceptorUserId = [[${userId}]];
    </script>
    <script th:src="@{/static/easyui/easy.common.js}"></script>
    <script th:src="@{/static/easyuiMask.js}"></script>
    <script th:src="@{/static/myFun.js}"></script>
    <script th:inline="javascript">
        alert(1);

        var templateNodeArr = new Array();

        function templateTreeInit() {
            var result = ajaxSynchGet("user/flowTemplate/getTemplateTree", null);
            if (result.code == '200') {
                $('#templateTree').tree({
                    lines : true,
                    multiple : false,
                    checkbox : false,
                    data : result.data,
                    onSelect: function(template) {
                        var result = ajaxSynchGet("user/flowTemplate/getTemplatetemplateNodeTree", {"id": template.id, "pid":0});
                        if (result.code == '200') {
                            var status = result.data.status;
                            if (status == 0) { // 正常
                                $("#templateStatus").text("模板状态：正常");
                            } else { // 冻结
                                $("#templateStatus").text("模板状态：冻结");
                            }

                            var nodeList = result.data.templateNodeList;
                            $('#templateNodeTree').tree({
                                lines : true,
                                multiple : false,
                                checkbox : false,
                                data : nodeList,
                                onBeforeExpand: function(node) {
                                    if (templateNodeArr.indexOf(node.id) == -1) {
                                        openTemplateNode(node, template.id, node.id);
                                    }
                                    //return true;
                                }
                            });
                        } else {
                            alertWarn(result.msg);
                        }
                    }
                });
            } else {
                alertWarn(result.msg);
            }
        }

        function openTemplateNode(node, templateId, pid) {
            var result = ajaxSynchGet("user/flowTemplate/getTemplatetemplateNodeTree", {"id": templateId, "pid":pid});
            if (result.code == '200') {
                templateNodeArr.push(pid);
                $('#templateNodeTree').tree('append', {
                    parent : node.target, 
                    data : result.data
                });
            } else {
                alertWarn(result.msg);
            }
        }

        function addTemplateShow() {
            $('#templateNameAddTemplateForm').dialog('open');
        }

        function addTemplateCommit() {
            var templateName = $('#templateNameAddTemplateForm').val();
            var result = ajaxSynchPostJson("user/flowTemplate/save", {"templateName":templateName});
            if (result.code == '200') {
                alertSuccess();
                $('#templateNameAddTemplateForm').dialog('close');

                $('#templateTree').tree('append', {
                    data : {
                        "id": result.data.id,
                        "text": result.data.templateName,
                        "state": "close",
                    }
                });
            } else {
                alertWarn(result.msg);
            }
        }

        function operateTemplateState(type) {
            alert($("#templateTree").tree('getSelected');
            alert($("#templateTree").tree('getSelected').id);

            var msg = ""
            if (type == 0) { // 冻结
                msg = "确定要冻结吗？"
            } else if (type == 1) { // 启用
                msg = "确定要启用吗？"
            } else if (type == 2) { // 删除
                msg = "确定要删除吗？"
            }

            $.messager.confirm('确定操作', msg, function (flag) {
                if (flag) {
                    var result = ajaxSynchPostJson("user/flowTemplate/operateTemplateState?id=" + id + "&type=" + type, null);
                    if (result.code == '200') {
                        rowDimArr = new Array();
                        selectRowDimId = -1;
                        var result = ajaxSynchGet("user/formManage/getRowColDimensionTree", {"formId": selectFormId, "type":0});
                        if (result.code == '200') {
                            rowDimTreeInit(result.data);
                            alertInfo(result.msg);
                        } else {
                            alertWarn(result.msg);
                        }
                    }
                }
            });
        }

        function addNode(type) {

        }

        function editNodeShow() {

        }

        function deleteNode() {

        }

        $(function () {
            templateTreeInit();
        });
    </script>
</head>
<body>
<table id="manager">
    <div id="manager_tool">
        <div style="margin-bottom:5px;">
            <a href="#" class="easyui-linkbutton" iconCls="icon-add-green" plain="true" onclick="addTemplateShow()">新增模板</a>
            <a href="#" class="easyui-linkbutton" iconCls="icon-tip" plain="true" onclick="operateTemplateState(0)">冻结模板</a>
            <a href="#" class="easyui-linkbutton" iconCls="icon-ok" plain="true" onclick="operateTemplateState(1)">启用模板</a>
            <a href="#" class="easyui-linkbutton" iconCls="icon-cancel" plain="true" onclick="operateTemplateState(2)">删除表单</a>
        </div>

        <div>
            <div style="float:left; width: 25%">
                <ul id="templateTree"/>
            </div>
            <div style="float:left; width: 73%">
                <div>
                    <a href="#" class="easyui-linkbutton" iconCls="icon-add-green" plain="true" onclick="addNode(0)">新增一级节点</a>
                    <a href="#" class="easyui-linkbutton" iconCls="icon-add-green" plain="true" onclick="addNode(1)">新增子项节点</a>
                    <a href="#" class="easyui-linkbutton" iconCls="icon-edit-yellow" plain="true" onclick="editNodeShow()">编辑</a>
                    <a href="#" class="easyui-linkbutton" iconCls="icon-cancel" plain="true" onclick="deleteNode()">删除</a>
                </div>
                <div style="margin-top: 10px;">
                    <span id="templateStatus" style="padding-left: 10px;"></span>
                </div>
                <ul id="templateNodeTree"/>
            </div>
            <div style="clear:both;"></div>
        </div>
    </div>
</table>

<form id="addTemplateForm" class="easyui-dialog" style="margin:0;padding:5px 0 0 25px;color:#333;"
      data-options="top:150,width:320,title:'新增管理',modal:true,closed:true,cache:false,iconCls:'icon-user-add',
       onClose:function () {
            $('#addTemplateForm').form('reset');
       },
		buttons:[{
					text : '提交',
					iconCls : 'icon-add-green',
					handler : function () {
                    addTemplateCommit();
					}
				},{
					text:'关闭',
					iconCls : 'icon-redo',
					handler:function(){
                    $('#addTemplateForm').dialog('close');
					}
				}]">
    <p>模板名称：<input class="easyui-validatebox" type="text" id="templateNameAddTemplateForm" style="width:200px;" /></p>
</form>

</body>
</html>